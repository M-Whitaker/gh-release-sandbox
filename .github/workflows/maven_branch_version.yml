name: Maven Branch Version
run-name: Creating new ${{ github.event.inputs.releaseType }} version from master!

concurrency:
  group: maven-release-branch
  cancel-in-progress: false

on:
  workflow_dispatch:
    inputs:
      releaseType:
        description: 'Release type'
        required: true
        type: choice
        options:
          - minor
          - major
      dryRun:
        description: 'Dry run (no commits/push)'
        type: boolean
        default: false

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check workflow status on default branch
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              branch: 'master',
              status: 'completed',
              per_page: 1
            });

            if (!data.workflow_runs.length) {
              core.setFailed('No workflow runs found on master branch');
              return;
            }

            const run = data.workflow_runs[0];
            if (run.conclusion !== 'success') {
              core.setFailed(`Latest master branch run did not succeed (status: ${run.conclusion})`);
            }
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: false
          ref: master
      
      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}
      
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
      
      - name: Configure Git with credentials
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          # Configure Git user
          git config --global user.email "250615654+mw-releasebot[bot]@users.noreply.github.com"
          git config --global user.name "mw-releasebot[bot]"
          
          # Configure credential helper to store credentials
          git config --global credential.helper store
          
          # Store credentials for Maven to use
          echo "https://x-access-token:${GH_TOKEN}@github.com" > ~/.git-credentials
          chmod 600 ~/.git-credentials
          
          # Set remote URL with token
          git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git
          
          # Verify configuration
          echo "Git configuration:"
          git config --global user.name
          git config --global user.email
          git config --global credential.helper
          echo "Remote URL configured (token hidden)"
      
      - name: Extract and calculate versions
        id: get_version
        run: |
          CURRENT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "Current version is $CURRENT_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # Extract major.minor from version
          VERSION_PARTS=(${CURRENT_VERSION//./ })
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          
          # Calculate new versions based on release type
          # 
          # For minor: current is 0.13.0-SNAPSHOT
          # - Release branch will be: release/0.13.x (from current 0.13.0-SNAPSHOT)
          # - Next dev version (after branch): 0.14.0-SNAPSHOT
          #
          # For major: current is 0.13.0-SNAPSHOT
          # - Master bumps to: 1.0.0-SNAPSHOT (before branching)
          # - Release branch will be: release/1.0.x (from 1.0.0-SNAPSHOT)
          # - Next dev version (after branch): 1.1.0-SNAPSHOT
          
          if [ "${{ github.event.inputs.releaseType }}" == "major" ]; then
            # Major bump: 0.13.0-SNAPSHOT -> 1.0.0-SNAPSHOT (branch) -> 1.1.0-SNAPSHOT (master)
            NEW_MAJOR=$((MAJOR + 1))
            BRANCH_MINOR=0
            MASTER_MINOR=1
            
            BRANCH_VERSION="$NEW_MAJOR.$BRANCH_MINOR.0-SNAPSHOT"
            DEV_VERSION="$NEW_MAJOR.$MASTER_MINOR.0-SNAPSHOT"
          else
            # Minor bump: 0.13.0-SNAPSHOT -> 0.13.0-SNAPSHOT (branch) -> 0.14.0-SNAPSHOT (master)
            NEW_MAJOR=$MAJOR
            BRANCH_MINOR=$MINOR
            MASTER_MINOR=$((MINOR + 1))
            
            BRANCH_VERSION="$NEW_MAJOR.$BRANCH_MINOR.0-SNAPSHOT"
            DEV_VERSION="$NEW_MAJOR.$MASTER_MINOR.0-SNAPSHOT"
          fi
          
          RELEASE_BRANCH="release/$NEW_MAJOR.$BRANCH_MINOR.x"
          
          echo "branch_version=$BRANCH_VERSION" >> $GITHUB_OUTPUT
          echo "release_branch=$RELEASE_BRANCH" >> $GITHUB_OUTPUT
          echo "dev_version=$DEV_VERSION" >> $GITHUB_OUTPUT
          
          echo "Calculated versions:"
          echo "  Branch version: $BRANCH_VERSION"
          echo "  Release branch: $RELEASE_BRANCH"
          echo "  Master dev version: $DEV_VERSION"
      
      - name: Check if release branch exists
        id: check_branch
        run: |
          RELEASE_BRANCH="${{ steps.get_version.outputs.release_branch }}"
          echo "Checking if branch $RELEASE_BRANCH exists..."
          
          if [ "${{ github.event.inputs.dryRun }}" == "true" ]; then
            echo "In dry run mode, assuming branch doesn't exist."
            echo "branch_exists=false" >> $GITHUB_OUTPUT
            echo "[DRY RUN] Would check if $RELEASE_BRANCH exists"
          elif git ls-remote --heads origin $RELEASE_BRANCH | grep -q $RELEASE_BRANCH; then
            echo "Release branch $RELEASE_BRANCH already exists. Stopping workflow."
            echo "branch_exists=true" >> $GITHUB_OUTPUT
          else
            echo "Release branch does not exist. Will create $RELEASE_BRANCH."
            echo "branch_exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Stop if branch exists
        if: steps.check_branch.outputs.branch_exists == 'true'
        run: |
          echo "ERROR: Release branch already exists!"
          exit 1

      - name: Bump master to branch version (major only)
        if: steps.check_branch.outputs.branch_exists == 'false' && github.event.inputs.releaseType == 'major'
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          BRANCH_VERSION="${{ steps.get_version.outputs.branch_version }}"
          
          if [ "${{ github.event.inputs.dryRun }}" == "true" ]; then
            echo "[DRY RUN] Would update master to: $BRANCH_VERSION"
          else
            echo "Updating master to: $BRANCH_VERSION"
            
            # Update version in pom.xml
            mvn versions:set -DnewVersion="$BRANCH_VERSION" -DgenerateBackupPoms=false
            
            # Commit and push
            git add pom.xml
            git commit -m "[maven-release-plugin] prepare for major version $BRANCH_VERSION"
            git push origin master
            
            echo "✅ Master updated to $BRANCH_VERSION"
          fi

      - name: Create release branch
        if: steps.check_branch.outputs.branch_exists == 'false'
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          RELEASE_BRANCH="${{ steps.get_version.outputs.release_branch }}"
          DEV_VERSION="${{ steps.get_version.outputs.dev_version }}"
          BRANCH_VERSION="${{ steps.get_version.outputs.branch_version }}"
          
          # Prepare release args
          RELEASE_ARGS="--batch-mode"
          
          if [ "${{ github.event.inputs.dryRun }}" == "true" ]; then
            RELEASE_ARGS="$RELEASE_ARGS -DdryRun=true"
            echo "[DRY RUN] Would create branch: $RELEASE_BRANCH"
            echo "[DRY RUN] Branch would have version: $BRANCH_VERSION"
            echo "[DRY RUN] Would set master dev version to: $DEV_VERSION"
          else
            echo "Creating release branch: $RELEASE_BRANCH"
            echo "Branch will have version: $BRANCH_VERSION"
            echo "Setting master development version to: $DEV_VERSION"
          fi
          
          # Create the release branch using Maven Release Plugin
          mvn $RELEASE_ARGS \
            release:branch \
            -DbranchName="$RELEASE_BRANCH" \
            -DdevelopmentVersion="$DEV_VERSION" \
            -DpushChanges=true \
            -DautoVersionSubmodules=true \
            -DupdateBranchVersions=false \
            -DupdateWorkingCopyVersions=true \
            -DscmBranchCommitComment="@{prefix} prepare branch $RELEASE_BRANCH" \
            -DscmCommentPrefix="[maven-release-plugin] [skip ci]"
          
          if [ "${{ github.event.inputs.dryRun }}" != "true" ]; then
            echo "✅ Successfully created release branch: $RELEASE_BRANCH"
            echo "✅ Master branch updated to version: $DEV_VERSION"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "## Release Branch Creation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Type**: ${{ github.event.inputs.releaseType }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Current Version**: ${{ steps.get_version.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Branch**: ${{ steps.get_version.outputs.release_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch Version**: ${{ steps.get_version.outputs.branch_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **New Master Version**: ${{ steps.get_version.outputs.dev_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run**: ${{ github.event.inputs.dryRun }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_branch.outputs.branch_exists }}" == "true" ]; then
            echo "- **Status**: ❌ Branch already exists" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event.inputs.dryRun }}" == "true" ]; then
            echo "- **Status**: ℹ️ Dry run completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: ✅ Release branch created" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version Flow" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.releaseType }}" == "major" ]; then
            echo "1. Master: ${{ steps.get_version.outputs.current_version }} → ${{ steps.get_version.outputs.branch_version }}" >> $GITHUB_STEP_SUMMARY
            echo "2. Branch created: ${{ steps.get_version.outputs.release_branch }} (${{ steps.get_version.outputs.branch_version }})" >> $GITHUB_STEP_SUMMARY
            echo "3. Master: ${{ steps.get_version.outputs.branch_version }} → ${{ steps.get_version.outputs.dev_version }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "1. Branch created: ${{ steps.get_version.outputs.release_branch }} (${{ steps.get_version.outputs.branch_version }})" >> $GITHUB_STEP_SUMMARY
            echo "2. Master: ${{ steps.get_version.outputs.current_version }} → ${{ steps.get_version.outputs.dev_version }}" >> $GITHUB_STEP_SUMMARY
          fi
