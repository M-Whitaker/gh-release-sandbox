name: Release Workflow
run-name: Releasing ${{ github.ref_name }} ðŸš€
on:
  push:
    tags:
      - 'rel_*'
jobs:
  Explore-GitHub-Actions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}
      - name: Configure Git with credentials
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          # Configure Git user
          git config --global user.email "250615654+mw-releasebot[bot]@users.noreply.github.com"
          git config --global user.name "mw-releasebot[bot]"
          
          # Configure credential helper to store credentials
          git config --global credential.helper store
          
          # Store credentials for Maven to use
          echo "https://x-access-token:${GH_TOKEN}@github.com" > ~/.git-credentials
          chmod 600 ~/.git-credentials
          
          # Set remote URL with token
          git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git
          
          # Verify configuration
          echo "Git configuration:"
          git config --global user.name
          git config --global user.email
          git config --global credential.helper
          echo "Remote URL configured (token hidden)"
      - name: Changelog from Conventional Commits
        id: changelog
        uses: requarks/changelog-action@v1
        with:
          excludeTypes: "build,docs,test,ci"
          token: ${{ github.token }}
          tag: ${{ github.ref_name }}
      - name: Create Release
        uses: ncipollo/release-action@v1.12.0
        with:
          allowUpdates: true
          draft: false
          makeLatest: true
          name: ${{ github.ref_name }}
          body: ${{ steps.changelog.outputs.changes }}
          token: ${{ github.token }}
      - name: Commit CHANGELOG.md
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          branch: master
          commit_message: 'docs: update CHANGELOG.md for ${{ github.ref_name }} [skip ci]'
          file_pattern: CHANGELOG.md
